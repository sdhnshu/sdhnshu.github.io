<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Sudhanshu Passi - Affordable Deep Learning with automated AWS Spot Instances</title><meta name=description content="Sudhanshu Passi's personal website"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=https://www.sdhnshu.com/css/bootstrap.min.css><link href="https://fonts.googleapis.com/css2?family=Lato&family=Merriweather:wght@300&display=swap" rel=stylesheet><link rel=stylesheet href=https://www.sdhnshu.com/css/font-awesome.min.css><link rel=stylesheet href=https://www.sdhnshu.com/css/owl.carousel.css><link rel=stylesheet href=https://www.sdhnshu.com/css/owl.theme.css><link href=https://www.sdhnshu.com/css/style.violet.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/atom-one-dark.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link href=https://www.sdhnshu.com/css/custom.css rel=stylesheet><link rel="shortcut icon" href=https://www.sdhnshu.com/img/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-173272544-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=all><div class=container-fluid><div class="row row-offcanvas row-offcanvas-left"><div id=sidebar class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas"><div class=sidebar-content><h1 class=sidebar-heading><a href=https://www.sdhnshu.com/>Sudhanshu Passi</a></h1><ul class=sidebar-menu><li><a href=https://www.sdhnshu.com/showcase/>Showcase</a></li><li><a href=https://www.sdhnshu.com/experiments/>Experiments</a></li><li><a href=https://www.sdhnshu.com/about/>About</a></li></ul><p class=social><a href=https://github.com/sdhnshu data-animate-hover=pulse class=external><i class="fa fa-github"></i></a><a href=mailto:sudhanshupassi@gmail.com data-animate-hover=pulse class=email><i class="fa fa-envelope"></i></a><a href=https://www.linkedin.com/in/sdhnshu/ data-animate-hover=pulse class=external><i class="fa fa-linkedin"></i></a><a href=https://twitter.com/Sudhanshupassi data-animate-hover=pulse class="external twitter"><i class="fa fa-twitter"></i></a><a href=https://medium.com/@sdhnshu data-animate-hover=pulse class=external><i class="fa fa-medium"></i></a></p><div class=copyright><p class=credit>&copy; 2020 Sudhanshu Passi</p></div></div></div><div class="col-xs-12 col-sm-8 col-md-9 content-column white-background"><div class="small-navbar visible-xs"><button type=button data-toggle=offcanvas class="btn btn-ghost pull-left"> <i class="fa fa-align-left"></i>Menu</button><h1 class=small-navbar-heading><a href=https://www.sdhnshu.com/>Sudhanshu Passi</a></h1></div><div class=row><div class=col-lg-11><div class=content-column-content><h1>Affordable Deep Learning with automated AWS Spot Instances</h1><i><p class=timestamp>Last updated Feb 14, 2019</p></i><p>The easiest way to get the cheapest Amazon instances for your deep learning projects.</p><p><img src=https://miro.medium.com/max/573/0*Ws2g7yqu0dYEcmwO.jpg alt=img></p><ul><li>Originally published on <a href=https://medium.com/@sdhnshu/pro-deep-learning-setup-at-90-off-e9e68f5e84ec>Medium</a></li><li>All code available on <a href=https://github.com/sdhnshu/Deep-Jupyter-Portal>Github</a></li></ul><h3 id=introduction>Introduction</h3><p><strong>Amazon Spot instances</strong> offer <strong>spare compute capacity</strong> available at <strong>steep discounts</strong>. You can check out the pricing <a href=https://aws.amazon.com/ec2/spot/pricing/>here</a>. The only catch is, these instances can be taken away from you anytime.</p><p>For a person who wants to focus on deep learning and not on making spot instances reliable, I’ve automated the process and set up the project here: <em><a href=https://github.com/sdhnshu/Deep-Jupyter-Portal>github.com/Deep-Jupyter-Portal</a></em></p><p>Spot instances can be launched with any AMI (Amazon Machine Image). We’ll be choosing an AMI with all deep learning libraries installed. The package includes some storage (in our case 60–75GB) and I am choosing a g2.2xlarge machine which has 8 core CPU, 15 GB RAM, and NVIDIA GK104 GPU with 8GB graphics memory.</p><p>In the time of my using spot instances, I’ve seen them stable for days. But we’ll setup another persistent storage (20 GB) that will never be taken away from us, later in this post. All our data will be saved in this volume.</p><h4 id=what-would-you-get>What would you get?</h4><p>Once your preferences are setup, with <strong>one command</strong>, you can spawn a cheap AWS instance. With another you can launch a <strong>jupyter notebook</strong> on it, which automatically opens up in your browser. It also automatically syncs back the data from the server to your machine.</p><h4 id=4-step-installation>4 step installation</h4><p>We’ll be using a library called portal-gun (v 0.2.0). It can automate the reservation of a spot instance. Check out its <a href=https://portal-gun.readthedocs.io/en/stable/>documentation</a> for more details.</p><p>Clone this <a href=https://github.com/sdhnshu/Deep-Jupyter-Portal>github.com/Deep-Jupyter-Portal</a> and setup a python 2.7 environment. Install the requirements.txt in the environment. To setup the config for portal-gun, we need to setup four things in AWS.</p><h4 id=step-1-iam-user>Step 1. IAM user</h4><p>Portal-gun will need some access keys for communicating to AWS. Create a new IAM user <a href=https://console.aws.amazon.com/iam/home>here</a>, and give it programmatic access. You’ll see the following screen.</p><p><img src=https://miro.medium.com/max/573/1*brtvmLnSuqz1GQoKu4ancg.png alt="Create Iam user"></p><p>To attach a policy, create a new one with the following permissions and attach it to the user. These are all the permissions portal-gun needs to access the servers.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
    <span style=color:#f92672>&#34;Statement&#34;</span>: [
        {
            <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
            <span style=color:#f92672>&#34;Action&#34;</span>: [
                <span style=color:#e6db74>&#34;iam:PassRole&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeAccountAttributes&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeAvailabilityZones&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSubnets&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:CreateVolume&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:ModifyVolume&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:AttachVolume&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DetachVolume&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DeleteVolume&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeVolumes&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeVolumeStatus&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeVolumeAttribute&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeVolumesModifications&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:RequestSpotFleet&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:CancelSpotFleetRequests&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:RequestSpotInstances&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:CancelSpotInstanceRequests&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:ModifySpotFleetRequest&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:ModifyInstanceAttribute&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSpotFleetRequests&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSpotInstanceRequests&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSpotFleetInstances&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSpotPriceHistory&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeSpotFleetRequestHistory&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeInstances&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeInstanceStatus&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeInstanceAttribute&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:CreateTags&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DeleteTags&#34;</span>,
                <span style=color:#e6db74>&#34;ec2:DescribeTags&#34;</span>
            ],
            <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>
        }
    ]
}
</code></pre></div><p>You’ll get an access key and a secret key after the user is created. Make a file <em>~/.portal-gun/config.json</em> if not present and add/replace the following lines to it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;aws_region&#34;</span>: <span style=color:#e6db74>&#34;us-east-1&#34;</span>,
    <span style=color:#f92672>&#34;aws_access_key&#34;</span>: <span style=color:#e6db74>&#34;AKIAXXXXXXXXX7F6QQ&#34;</span>,
    <span style=color:#f92672>&#34;aws_secret_key&#34;</span>: <span style=color:#e6db74>&#34;Ji4esAyXXXXXXXXXXXXXXXXXXXXXXXXXtrQBjcg&#34;</span>
}
</code></pre></div><p>I’ll be working in the US East (N Virginia) region, because they have all the GPU machines one can think of.</p><h4 id=step-2-rsa-keys>Step 2. RSA keys</h4><p>To ssh into the server, we need to add your laptop’s RSA public key (~/.ssh/id_rsa.pub) to the key-pairs in the EC2 tab. Note down the key pair name.</p><p><img src=https://miro.medium.com/max/573/1*gwxJfptEoI-APfwDPDpV_g.png alt="Rsa keys"></p><h4 id=step-3-security-group>Step 3. Security Group</h4><p>Create a new security group using the network and security section on the left. Make a group with 22 (ssh) and 8888 (jupyter) ports open. This would allow communication through these ports. Note down the security group id.</p><p><img src=https://miro.medium.com/max/573/1*X9QsJLMxbzC3jmsW7WLYvA.png alt="sec group"></p><h4 id=step-4-persistent-volume>Step 4. Persistent volume</h4><p>The volumes with the AMI would be destroyed when the spot instance is taken away from you. Create a volume in the us-east-1a region using the Elastic Block Store section on the left. This would be used for our permanent storage. Note down the volume id.</p><p><img src=https://miro.medium.com/max/573/1*wgOYPAioOK35WLVfR6DOYw.png alt=volume></p><h4 id=step-5-ami-optional>Step 5. AMI (optional)</h4><p>I’ve chosen the deep learning AMI v21.0. It has all deep learning frameworks installed with CUDA and CuDNN. Note down the AMI id.</p><p><img src=https://miro.medium.com/max/573/1*HEGhWvHprMN7pT9imtw30g.png alt=ami></p><p><strong><em>If you are using the same AMI as I am, you can jump to the next section.</em></strong></p><p>To find out what mount points are free in the AMI, we need to first start an instance just with just the AMI and run <code>lsblk</code>.</p><p><img src=https://miro.medium.com/max/316/1*PejpOV_FJ9QooVSSaMrjUw.png alt=lbsk></p><p>Here we can see 2 disks xvda and xvdb are mounted. We can use generally use xvd(g-j) for our usage. If it says sda, sdb in your AMI, choose something within sd(g-j). I’ve chosen xvdg.</p><h4 id=verifying-the-config-file>Verifying the config file</h4><p>Open up the deep_gpu.json file from the repo. Check all marked values and change them to your needs. Put your account number in the morphed location in iam_fleet_role. You can find your account number here on the top left.</p><p>The channels block is for a real-time sync of data between your local machine and the server. Direction in specifies server to local and out stands for local to server.</p><p>Remember to keep both <em>local_paths</em> different.</p><p><img src=https://miro.medium.com/max/573/1*DusmttvQI49TXsoZdOK71A.png alt=deepgpu.json></p><h3 id=opening-the-portal>Opening the portal</h3><p>To start the portal, we use the following command from the path where deep_gpu.json is located.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>portal open deep_gpu
</code></pre></div><p><img src=https://miro.medium.com/max/484/1*Po9bZb0X8gg3Qdoz39MnXw.png alt="open the portal"></p><p>For me it takes around 4 minutes to find and setup the machine. To interact with the AWS instance, use the following commands.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>portal open deep_gpu
portal info deep_gpu
portal ssh deep_gpu
portal close deep_gpu
</code></pre></div><h3 id=starting-the-jupyter-notebook>Starting the jupyter notebook</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>python start_jupyter.py
</code></pre></div><p>This will run the jupyter notebook on the machine and open it in your browser. The jupyter service might take a while to start. Refresh the browser in a while.</p><p>Starting the jupyter notebook also starts the sync process and syncs both folders as anything changes in them.</p><p>After you are done working, just use the following command to terminate the spot instance.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>portal close deep_gpu
</code></pre></div><p>Reach out to me in the comments if you have any issues.</p><h4 id=references>References</h4><ul><li><a href=https://hackernoon.com/@coderik>Vadim Fedorov</a> for making the library (portal-gun). You can check out his blog post <a href=https://hackernoon.com/deep-learning-on-amazon-ec2-spot-instances-without-the-agonizing-pain-4cedf9b129c4>here</a>.</li></ul></div></div></div></div></div></div></div><script src=https://www.sdhnshu.com/js/jquery.min.js></script><script src=https://www.sdhnshu.com/js/bootstrap.min.js></script><script src=https://www.sdhnshu.com/js/jquery.cookie.js></script><script src=https://www.sdhnshu.com/js/ekko-lightbox.js></script><script src=https://www.sdhnshu.com/js/jquery.scrollTo.min.js></script><script src=https://www.sdhnshu.com/js/masonry.pkgd.min.js></script><script src=https://www.sdhnshu.com/js/imagesloaded.pkgd.min.js></script><script src=https://www.sdhnshu.com/js/owl.carousel.min.js></script><script src=https://www.sdhnshu.com/js/front.js></script></body></html>